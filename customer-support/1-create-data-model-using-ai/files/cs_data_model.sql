-- ============================================================================
-- TABLE: cs_customers
-- Represents the customer raising a support request
-- ============================================================================
CREATE TABLE cs_customers (
    customer_id       NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY
                      CONSTRAINT cs_customers_id_pk PRIMARY KEY,
    customer_name     VARCHAR2(255 CHAR) NOT NULL,
    customer_type     VARCHAR2(50 CHAR) DEFAULT 'Individual' 
                      CONSTRAINT cs_customers_type_chk 
                      CHECK (customer_type IN ('Individual', 'Corporate')),
    email             VARCHAR2(255 CHAR),
    mobile            VARCHAR2(50 CHAR),
    kyc_status        VARCHAR2(50 CHAR) DEFAULT 'Pending'
                      CONSTRAINT cs_customers_kyc_chk 
                      CHECK (kyc_status IN ('Pending', 'Verified', 'Rejected')),
    created_at        DATE NOT NULL,
    created_by        VARCHAR2(255 CHAR) NOT NULL,
    updated_at        DATE NOT NULL,
    updated_by        VARCHAR2(255 CHAR) NOT NULL
);

-- ============================================================================
-- TABLE: cs_accounts
-- Provides BFSI context like banking, loans, or cards
-- ============================================================================
CREATE TABLE cs_accounts (
    account_id              NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY
                            CONSTRAINT cs_accounts_id_pk PRIMARY KEY,
    customer_id             NUMBER NOT NULL
                            CONSTRAINT cs_accounts_customer_id_fk
                            REFERENCES cs_customers,
    account_number_masked   VARCHAR2(50 CHAR) NOT NULL,
    account_type            VARCHAR2(50 CHAR) NOT NULL
                            CONSTRAINT cs_accounts_type_chk 
                            CHECK (account_type IN ('Savings', 'Current', 'Loan', 'Credit Card', 'Fixed Deposit')),
    status                  VARCHAR2(50 CHAR) DEFAULT 'Active'
                            CONSTRAINT cs_accounts_status_chk 
                            CHECK (status IN ('Active', 'Inactive', 'Blocked', 'Closed')),
    created_at              DATE NOT NULL,
    created_by              VARCHAR2(255 CHAR) NOT NULL,
    updated_at              DATE NOT NULL,
    updated_by              VARCHAR2(255 CHAR) NOT NULL
);

-- Index on customer_id for faster lookups
CREATE INDEX cs_accounts_i1 ON cs_accounts (customer_id);

-- ============================================================================
-- TABLE: cs_agents
-- Support users handling tickets
-- ============================================================================
CREATE TABLE cs_agents (
    agent_id          NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY
                      CONSTRAINT cs_agents_id_pk PRIMARY KEY,
    agent_name        VARCHAR2(255 CHAR) NOT NULL,
    email             VARCHAR2(255 CHAR) NOT NULL,
    role              VARCHAR2(50 CHAR) DEFAULT 'L1'
                      CONSTRAINT cs_agents_role_chk 
                      CHECK (role IN ('L1', 'L2', 'Supervisor', 'Manager')),
    active_flag       VARCHAR2(1 CHAR) DEFAULT 'Y'
                      CONSTRAINT cs_agents_active_chk 
                      CHECK (active_flag IN ('Y', 'N')),
    created_at        DATE NOT NULL,
    created_by        VARCHAR2(255 CHAR) NOT NULL,
    updated_at        DATE NOT NULL,
    updated_by        VARCHAR2(255 CHAR) NOT NULL
);

-- ============================================================================
-- TABLE: cs_tickets
-- The central support ticket entity
-- ============================================================================
CREATE TABLE cs_tickets (
    ticket_id           NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY
                        CONSTRAINT cs_tickets_id_pk PRIMARY KEY,
    ticket_number       VARCHAR2(50 CHAR) NOT NULL UNIQUE,
    customer_id         NUMBER NOT NULL
                        CONSTRAINT cs_tickets_customer_id_fk
                        REFERENCES cs_customers,
    account_id          NUMBER
                        CONSTRAINT cs_tickets_account_id_fk
                        REFERENCES cs_accounts,
    subject             VARCHAR2(500 CHAR) NOT NULL,
    description         VARCHAR2(4000 CHAR),
    priority            VARCHAR2(20 CHAR) DEFAULT 'Medium'
                        CONSTRAINT cs_tickets_priority_chk 
                        CHECK (priority IN ('Low', 'Medium', 'High', 'Critical')),
    status              VARCHAR2(50 CHAR) DEFAULT 'New'
                        CONSTRAINT cs_tickets_status_chk 
                        CHECK (status IN ('New', 'In Progress', 'Waiting', 'Resolved', 'Closed', 'Cancelled')),
    channel             VARCHAR2(50 CHAR) DEFAULT 'Email'
                        CONSTRAINT cs_tickets_channel_chk 
                        CHECK (channel IN ('Phone', 'Email', 'Chat', 'Branch', 'Mobile App', 'Web')),
    assigned_agent_id   NUMBER
                        CONSTRAINT cs_tickets_agent_id_fk
                        REFERENCES cs_agents,
    created_at          DATE NOT NULL,
    created_by          VARCHAR2(255 CHAR) NOT NULL,
    updated_at          DATE NOT NULL,
    updated_by          VARCHAR2(255 CHAR) NOT NULL,
    closed_at           DATE
);

-- Indexes for better query performance
CREATE INDEX cs_tickets_i1 ON cs_tickets (customer_id);
CREATE INDEX cs_tickets_i2 ON cs_tickets (account_id);
CREATE INDEX cs_tickets_i3 ON cs_tickets (assigned_agent_id);
CREATE INDEX cs_tickets_i4 ON cs_tickets (status);
CREATE INDEX cs_tickets_i5 ON cs_tickets (priority);
CREATE INDEX cs_tickets_i6 ON cs_tickets (created_at);

-- ============================================================================
-- TABLE: cs_ticket_updates
-- Timeline of everything that happens on a ticket
-- ============================================================================
CREATE TABLE cs_ticket_updates (
    update_id         NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY
                      CONSTRAINT cs_ticket_updates_id_pk PRIMARY KEY,
    ticket_id         NUMBER NOT NULL
                      CONSTRAINT cs_ticket_updates_ticket_id_fk
                      REFERENCES cs_tickets,
    update_text       VARCHAR2(4000 CHAR) NOT NULL,
    updated_by        VARCHAR2(255 CHAR) NOT NULL,
    updated_at        DATE NOT NULL
);

-- Index for faster ticket timeline retrieval
CREATE INDEX cs_ticket_updates_i1 ON cs_ticket_updates (ticket_id);
CREATE INDEX cs_ticket_updates_i2 ON cs_ticket_updates (updated_at);

-- ============================================================================
-- TABLE: cs_interactions
-- Stores customer conversations across channels
-- ============================================================================
CREATE TABLE cs_interactions (
    interaction_id    NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY
                      CONSTRAINT cs_interactions_id_pk PRIMARY KEY,
    ticket_id         NUMBER NOT NULL
                      CONSTRAINT cs_interactions_ticket_id_fk
                      REFERENCES cs_tickets,
    channel           VARCHAR2(50 CHAR) NOT NULL
                      CONSTRAINT cs_interactions_channel_chk 
                      CHECK (channel IN ('Call', 'Chat', 'Email', 'SMS', 'Branch')),
    message_text      VARCHAR2(4000 CHAR),
    direction         VARCHAR2(20 CHAR) DEFAULT 'Inbound'
                      CONSTRAINT cs_interactions_direction_chk 
                      CHECK (direction IN ('Inbound', 'Outbound')),
    created_at        DATE NOT NULL,
    created_by        VARCHAR2(255 CHAR) NOT NULL
);

-- Indexes for interaction queries
CREATE INDEX cs_interactions_i1 ON cs_interactions (ticket_id);
CREATE INDEX cs_interactions_i2 ON cs_interactions (created_at);

-- ============================================================================
-- TABLE: cs_sla
-- Simplified SLA tracking
-- ============================================================================
CREATE TABLE cs_sla (
    sla_id              NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY
                        CONSTRAINT cs_sla_id_pk PRIMARY KEY,
    ticket_id           NUMBER NOT NULL UNIQUE
                        CONSTRAINT cs_sla_ticket_id_fk
                        REFERENCES cs_tickets,
    response_due_at     DATE NOT NULL,
    resolution_due_at   DATE NOT NULL,
    sla_status          VARCHAR2(20 CHAR) DEFAULT 'On Track'
                        CONSTRAINT cs_sla_status_chk 
                        CHECK (sla_status IN ('On Track', 'At Risk', 'Breached')),
    created_at          DATE NOT NULL,
    created_by          VARCHAR2(255 CHAR) NOT NULL,
    updated_at          DATE NOT NULL,
    updated_by          VARCHAR2(255 CHAR) NOT NULL
);

-- Note: ticket_id already has a unique constraint, so no additional index needed
CREATE INDEX cs_sla_i1 ON cs_sla (sla_status);

-- ============================================================================
-- TRIGGERS: Audit columns (created_at, created_by, updated_at, updated_by)
-- ============================================================================

CREATE OR REPLACE TRIGGER cs_customers_biu
    BEFORE INSERT OR UPDATE ON cs_customers
    FOR EACH ROW
BEGIN
    IF INSERTING THEN
        :new.created_at := SYSDATE;
        :new.created_by := COALESCE(SYS_CONTEXT('APEX$SESSION','APP_USER'), USER);
    END IF;
    :new.updated_at := SYSDATE;
    :new.updated_by := COALESCE(SYS_CONTEXT('APEX$SESSION','APP_USER'), USER);
END cs_customers_biu;
/

CREATE OR REPLACE TRIGGER cs_accounts_biu
    BEFORE INSERT OR UPDATE ON cs_accounts
    FOR EACH ROW
BEGIN
    IF INSERTING THEN
        :new.created_at := SYSDATE;
        :new.created_by := COALESCE(SYS_CONTEXT('APEX$SESSION','APP_USER'), USER);
    END IF;
    :new.updated_at := SYSDATE;
    :new.updated_by := COALESCE(SYS_CONTEXT('APEX$SESSION','APP_USER'), USER);
END cs_accounts_biu;
/

CREATE OR REPLACE TRIGGER cs_agents_biu
    BEFORE INSERT OR UPDATE ON cs_agents
    FOR EACH ROW
BEGIN
    IF INSERTING THEN
        :new.created_at := SYSDATE;
        :new.created_by := COALESCE(SYS_CONTEXT('APEX$SESSION','APP_USER'), USER);
    END IF;
    :new.updated_at := SYSDATE;
    :new.updated_by := COALESCE(SYS_CONTEXT('APEX$SESSION','APP_USER'), USER);
END cs_agents_biu;
/

CREATE OR REPLACE TRIGGER cs_tickets_biu
    BEFORE INSERT OR UPDATE ON cs_tickets
    FOR EACH ROW
BEGIN
    IF INSERTING THEN
        -- Only set created_at if not explicitly provided
        IF :new.created_at IS NULL THEN
            :new.created_at := SYSDATE;
        END IF;
        :new.created_by := COALESCE(:new.created_by, SYS_CONTEXT('APEX$SESSION','APP_USER'), USER);
        -- Auto-generate ticket number if not provided
        IF :new.ticket_number IS NULL THEN
            :new.ticket_number := 'TICKET-' || TO_CHAR(SYSDATE, 'YYYYMMDD') || '-' || :new.ticket_id;
        END IF;
    END IF;
    -- Only set updated_at if not explicitly provided
    IF :new.updated_at IS NULL THEN
        :new.updated_at := SYSDATE;
    END IF;
    :new.updated_by := COALESCE(:new.updated_by, SYS_CONTEXT('APEX$SESSION','APP_USER'), USER);
    
    -- Set closed_at when status changes to Closed or Resolved
    IF :new.status IN ('Closed', 'Resolved') AND :old.status NOT IN ('Closed', 'Resolved') THEN
        :new.closed_at := SYSDATE;
    END IF;
END cs_tickets_biu;
/

CREATE OR REPLACE TRIGGER cs_sla_biu
    BEFORE INSERT OR UPDATE ON cs_sla
    FOR EACH ROW
BEGIN
    IF INSERTING THEN
        :new.created_at := SYSDATE;
        :new.created_by := COALESCE(SYS_CONTEXT('APEX$SESSION','APP_USER'), USER);
    END IF;
    :new.updated_at := SYSDATE;
    :new.updated_by := COALESCE(SYS_CONTEXT('APEX$SESSION','APP_USER'), USER);
END cs_sla_biu;
/

-- ============================================================================
-- TRIGGER: Auto-create timeline entry when ticket is created
-- ============================================================================
CREATE OR REPLACE TRIGGER cs_tickets_timeline_ai
    AFTER INSERT ON cs_tickets
    FOR EACH ROW
BEGIN
    INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
    VALUES (
        :new.ticket_id,
        'Ticket created with priority: ' || :new.priority || ', status: ' || :new.status,
        :new.created_by,
        :new.created_at
    );
END cs_tickets_timeline_ai;
/

-- ============================================================================
-- TRIGGER: Auto-create timeline entry when ticket status or assignment changes
-- ============================================================================
CREATE OR REPLACE TRIGGER cs_tickets_timeline_au
    AFTER UPDATE ON cs_tickets
    FOR EACH ROW
DECLARE
    v_update_text VARCHAR2(4000);
BEGIN
    -- Track status changes
    IF :new.status != :old.status THEN
        v_update_text := 'Status changed from ' || :old.status || ' to ' || :new.status;
        INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
        VALUES (:new.ticket_id, v_update_text, :new.updated_by, SYSDATE);
    END IF;
    
    -- Track assignment changes
    IF NVL(:new.assigned_agent_id, -1) != NVL(:old.assigned_agent_id, -1) THEN
        IF :old.assigned_agent_id IS NULL THEN
            v_update_text := 'Ticket assigned to agent ID: ' || :new.assigned_agent_id;
        ELSIF :new.assigned_agent_id IS NULL THEN
            v_update_text := 'Ticket unassigned from agent ID: ' || :old.assigned_agent_id;
        ELSE
            v_update_text := 'Ticket reassigned from agent ID: ' || :old.assigned_agent_id || 
                           ' to agent ID: ' || :new.assigned_agent_id;
        END IF;
        INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
        VALUES (:new.ticket_id, v_update_text, :new.updated_by, SYSDATE);
    END IF;
    
    -- Track priority changes
    IF :new.priority != :old.priority THEN
        v_update_text := 'Priority changed from ' || :old.priority || ' to ' || :new.priority;
        INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
        VALUES (:new.ticket_id, v_update_text, :new.updated_by, SYSDATE);
    END IF;
END cs_tickets_timeline_au;
/

-- ============================================================================
-- TRIGGER: Auto-create SLA record when ticket is created
-- ============================================================================
CREATE OR REPLACE TRIGGER cs_tickets_sla_ai
    AFTER INSERT ON cs_tickets
    FOR EACH ROW
DECLARE
    v_response_hours NUMBER;
    v_resolution_hours NUMBER;
BEGIN
    -- Set SLA hours based on priority
    CASE :new.priority
        WHEN 'Critical' THEN
            v_response_hours := 1;
            v_resolution_hours := 4;
        WHEN 'High' THEN
            v_response_hours := 2;
            v_resolution_hours := 8;
        WHEN 'Medium' THEN
            v_response_hours := 8;
            v_resolution_hours := 24;
        WHEN 'Low' THEN
            v_response_hours := 24;
            v_resolution_hours := 72;
        ELSE
            v_response_hours := 8;
            v_resolution_hours := 24;
    END CASE;
    
    -- Create SLA record
    INSERT INTO cs_sla (
        ticket_id,
        response_due_at,
        resolution_due_at,
        sla_status
    ) VALUES (
        :new.ticket_id,
        :new.created_at + (v_response_hours / 24),
        :new.created_at + (v_resolution_hours / 24),
        'On Track'
    );
END cs_tickets_sla_ai;
/

-- ============================================================================
-- TRIGGER: Update SLA status based on current time
-- ============================================================================
CREATE OR REPLACE TRIGGER cs_sla_status_check
    BEFORE UPDATE ON cs_sla
    FOR EACH ROW
DECLARE
    v_ticket_status VARCHAR2(50);
BEGIN
    -- Get ticket status
    SELECT status INTO v_ticket_status
    FROM cs_tickets
    WHERE ticket_id = :new.ticket_id;
    
    -- Only update SLA status if ticket is not closed or resolved
    IF v_ticket_status NOT IN ('Closed', 'Resolved') THEN
        IF SYSDATE > :new.resolution_due_at THEN
            :new.sla_status := 'Breached';
        ELSIF SYSDATE > (:new.resolution_due_at - 2/24) THEN  -- Within 2 hours of breach
            :new.sla_status := 'At Risk';
        ELSE
            :new.sla_status := 'On Track';
        END IF;
    END IF;
END cs_sla_status_check;
/

CREATE OR REPLACE TRIGGER cs_ticket_updates_biu
BEFORE INSERT OR UPDATE ON cs_ticket_updates
FOR EACH ROW
BEGIN
    -- Set UPDATED_AT to current timestamp if not provided
    IF :new.updated_at IS NULL THEN
        :new.updated_at := SYSDATE;
    END IF;
    -- Set UPDATED_BY if not populated
    IF :new.updated_by IS NULL THEN
        :new.updated_by := COALESCE(SYS_CONTEXT('APEX$SESSION','APP_USER'), USER);
    END IF;
END cs_ticket_updates_biu;
/

CREATE OR REPLACE TRIGGER cs_interactions_biu
BEFORE INSERT OR UPDATE ON cs_interactions
FOR EACH ROW
BEGIN
    IF INSERTING THEN
        -- Only set created_at if not explicitly provided
        IF :new.created_at IS NULL THEN
            :new.created_at := SYSDATE;
        END IF;
        :new.created_by := COALESCE(:new.created_by, SYS_CONTEXT('APEX$SESSION','APP_USER'), USER);
    END IF;
END cs_interactions_biu;
/

-- ============================================================================
-- SAMPLE DATA
-- ============================================================================

-- Customers
INSERT INTO cs_customers (customer_id, customer_name, customer_type, email, mobile, kyc_status)
VALUES (1, 'Alice Smith',      'Individual', 'alice@example.com', '9123450001', 'Verified');
INSERT INTO cs_customers (customer_id, customer_name, customer_type, email, mobile, kyc_status)
VALUES (2, 'Beta Ltd.',        'Corporate',  'contact@betaltd.com', '9123450002', 'Pending');
INSERT INTO cs_customers (customer_id, customer_name, customer_type, email, mobile, kyc_status)
VALUES (3, 'Charlie Brown',    'Individual', 'charlie.b@example.com', '9123450003', 'Verified');
INSERT INTO cs_customers (customer_id, customer_name, customer_type, email, mobile, kyc_status)
VALUES (4, 'Delta Corp',       'Corporate',  'help@delta.com', '9123450004', 'Rejected');
INSERT INTO cs_customers (customer_id, customer_name, customer_type, email, mobile, kyc_status)
VALUES (5, 'Eve Miller',       'Individual', 'eve.m@gmail.com', '9123450005', 'Pending');
INSERT INTO cs_customers (customer_id, customer_name, customer_type, email, mobile, kyc_status)
VALUES (6, 'Foxtrot Group',    'Corporate',  'service@foxtrot.com', '9123450006', 'Verified');
INSERT INTO cs_customers (customer_id, customer_name, customer_type, email, mobile, kyc_status)
VALUES (7, 'Grace Hopper',     'Individual', 'grace.hopper@example.com', '9123450007', 'Verified');
INSERT INTO cs_customers (customer_id, customer_name, customer_type, email, mobile, kyc_status)
VALUES (8, 'Hotel Inc.',       'Corporate',  'info@hotelinc.com', '9123450008', 'Pending');
INSERT INTO cs_customers (customer_id, customer_name, customer_type, email, mobile, kyc_status)
VALUES (9, 'Ivy Lane',         'Individual', 'ivy.lane@example.com', '9123450009', 'Rejected');
INSERT INTO cs_customers (customer_id, customer_name, customer_type, email, mobile, kyc_status)
VALUES (10, 'Juliet Test',      'Individual', 'juliet@test.com', '9123450010', 'Verified');

-- Accounts
INSERT INTO cs_accounts (account_id, customer_id, account_number_masked, account_type, status)
VALUES (1, 1,  'XXXX-1234', 'Savings',      'Active');
INSERT INTO cs_accounts (account_id, customer_id, account_number_masked, account_type, status)
VALUES (2, 2,  'XXXX-5678', 'Current',      'Active');
INSERT INTO cs_accounts (account_id, customer_id, account_number_masked, account_type, status)
VALUES (3, 3,  'XXXX-2345', 'Loan',         'Blocked');
INSERT INTO cs_accounts (account_id, customer_id, account_number_masked, account_type, status)
VALUES (4, 4,  'XXXX-6789', 'Credit Card',  'Active');
INSERT INTO cs_accounts (account_id, customer_id, account_number_masked, account_type, status)
VALUES (5, 5,  'XXXX-3456', 'Fixed Deposit','Inactive');
INSERT INTO cs_accounts (account_id, customer_id, account_number_masked, account_type, status)
VALUES (6, 6,  'XXXX-7890', 'Savings',      'Closed');
INSERT INTO cs_accounts (account_id, customer_id, account_number_masked, account_type, status)
VALUES (7, 7,  'XXXX-4567', 'Current',      'Active');
INSERT INTO cs_accounts (account_id, customer_id, account_number_masked, account_type, status)
VALUES (8, 8,  'XXXX-8901', 'Loan',         'Active');
INSERT INTO cs_accounts (account_id, customer_id, account_number_masked, account_type, status)
VALUES (9, 9,  'XXXX-5678', 'Credit Card',  'Inactive');
INSERT INTO cs_accounts (account_id, customer_id, account_number_masked, account_type, status)
VALUES (10, 10, 'XXXX-1234', 'Savings',     'Active');

-- Agents
INSERT INTO cs_agents (agent_id, agent_name, email, role, active_flag)
VALUES (1, 'Rita Rao',         'rita.rao@org.com',         'L1',         'Y');
INSERT INTO cs_agents (agent_id, agent_name, email, role, active_flag)
VALUES (2, 'Vikas Sharma',     'vikas.sharma@org.com',     'L2',         'Y');
INSERT INTO cs_agents (agent_id, agent_name, email, role, active_flag)
VALUES (3, 'Sunita Patel',     'sunita.patel@org.com',     'Supervisor', 'Y');
INSERT INTO cs_agents (agent_id, agent_name, email, role, active_flag)
VALUES (4, 'Alex King',        'alex.king@org.com',        'L1',         'Y');
INSERT INTO cs_agents (agent_id, agent_name, email, role, active_flag)
VALUES (5, 'Edna Knight',      'edna.knight@org.com',      'Manager',    'Y');
INSERT INTO cs_agents (agent_id, agent_name, email, role, active_flag)
VALUES (6, 'Parul Mehta',      'parul.mehta@org.com',      'L2',         'N');
INSERT INTO cs_agents (agent_id, agent_name, email, role, active_flag)
VALUES (7, 'Mohit Jain',       'mohit.jain@org.com',       'L1',         'Y');
INSERT INTO cs_agents (agent_id, agent_name, email, role, active_flag)
VALUES (8, 'Tina Das',         'tina.das@org.com',         'Supervisor', 'Y');
INSERT INTO cs_agents (agent_id, agent_name, email, role, active_flag)
VALUES (9, 'Priya S',          'priya.s@org.com',          'L1',         'Y');
INSERT INTO cs_agents (agent_id, agent_name, email, role, active_flag)
VALUES (10, 'Sunil Menon',      'sunil.menon@org.com',      'L2',         'Y');

-- Tickets with dates spread across 3 months (two previous months and current month)
-- Month 1 (approximately 60-75 days ago)
INSERT INTO cs_tickets (ticket_id, ticket_number, customer_id, account_id, subject, description, priority, status, channel, assigned_agent_id, created_at, updated_at, created_by, updated_by, closed_at)
VALUES (1, 'TICKET-20240101-1', 1, 1, 'KYC document not verified', 'Customer submitted KYC docs but not verified', 'Medium', 'Closed', 'Email', 1, SYSDATE - 68, SYSDATE - 65, 'SYSTEM', 'SYSTEM', SYSDATE - 65);

INSERT INTO cs_tickets (ticket_id, ticket_number, customer_id, account_id, subject, description, priority, status, channel, assigned_agent_id, created_at, updated_at, created_by, updated_by, closed_at)
VALUES (2, 'TICKET-20240101-2', 2, 2, 'Unable to access account', 'Corporate login fails with auth error', 'High', 'Resolved', 'Chat', 2, SYSDATE - 72, SYSDATE - 70, 'SYSTEM', 'SYSTEM', SYSDATE - 70);

INSERT INTO cs_tickets (ticket_id, ticket_number, customer_id, account_id, subject, description, priority, status, channel, assigned_agent_id, created_at, updated_at, created_by, updated_by)
VALUES (3, 'TICKET-20240101-3', 3, 3, 'Loan account showing blocked', 'Loan EMI paid, but blocked warning in app', 'Critical', 'Waiting', 'Mobile App', 3, SYSDATE - 61, SYSDATE - 60, 'SYSTEM', 'SYSTEM');

-- Month 2 (approximately 30-45 days ago)
INSERT INTO cs_tickets (ticket_id, ticket_number, customer_id, account_id, subject, description, priority, status, channel, assigned_agent_id, created_at, updated_at, created_by, updated_by)
VALUES (4, 'TICKET-20240101-4', 4, 4, 'Credit card payment pending', 'Customer reports payment not updated', 'Low', 'New', 'Phone', 4, SYSDATE - 42, SYSDATE - 42, 'SYSTEM', 'SYSTEM');

INSERT INTO cs_tickets (ticket_id, ticket_number, customer_id, account_id, subject, description, priority, status, channel, assigned_agent_id, created_at, updated_at, created_by, updated_by, closed_at)
VALUES (5, 'TICKET-20240101-5', 5, 5, 'Fixed deposit wrongly closed', 'FD closed without consent', 'High', 'Resolved', 'Email', 5, SYSDATE - 38, SYSDATE - 35, 'SYSTEM', 'SYSTEM', SYSDATE - 35);

INSERT INTO cs_tickets (ticket_id, ticket_number, customer_id, account_id, subject, description, priority, status, channel, assigned_agent_id, created_at, updated_at, created_by, updated_by, closed_at)
VALUES (6, 'TICKET-20240101-6', 6, 6, 'Closed account showing open', 'Savings account shows open after closure', 'Medium', 'Closed', 'Branch', 6, SYSDATE - 45, SYSDATE - 40, 'SYSTEM', 'SYSTEM', SYSDATE - 40);

INSERT INTO cs_tickets (ticket_id, ticket_number, customer_id, account_id, subject, description, priority, status, channel, assigned_agent_id, created_at, updated_at, created_by, updated_by)
VALUES (7, 'TICKET-20240101-7', 7, 7, 'Unable to withdraw cash', 'ATM not dispensing, account debited', 'Critical', 'In Progress', 'Phone', 7, SYSDATE - 33, SYSDATE - 32, 'SYSTEM', 'SYSTEM');

-- Current Month (0-20 days ago)
INSERT INTO cs_tickets (ticket_id, ticket_number, customer_id, account_id, subject, description, priority, status, channel, assigned_agent_id, created_at, updated_at, created_by, updated_by)
VALUES (8, 'TICKET-20240101-8', 8, 8, 'Loan account missing in app', 'Customer cannot see loan details', 'Medium', 'New', 'Web', 8, SYSDATE - 15, SYSDATE - 15, 'SYSTEM', 'SYSTEM');

INSERT INTO cs_tickets (ticket_id, ticket_number, customer_id, account_id, subject, description, priority, status, channel, assigned_agent_id, created_at, updated_at, created_by, updated_by)
VALUES (9, 'TICKET-20240101-9', 9, 9, 'Credit card limit reduced', 'Customer not informed before reduction', 'High', 'New', 'Email', 9, SYSDATE - 8, SYSDATE - 8, 'SYSTEM', 'SYSTEM');

INSERT INTO cs_tickets (ticket_id, ticket_number, customer_id, account_id, subject, description, priority, status, channel, assigned_agent_id, created_at, updated_at, created_by, updated_by)
VALUES (10, 'TICKET-20240101-10', 10, 10, 'Unable to withdraw - savings', 'Customer unable to withdraw even after sufficient funds', 'Medium', 'In Progress', 'Chat', 10, SYSDATE - 3, SYSDATE - 2, 'SYSTEM', 'SYSTEM');

-- Ticket Updates (manually inserted with proper dates spread across 3 months)
-- Month 1 updates (60-75 days ago)
INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
VALUES (1, 'KYC Pending verification.', 'agent1', SYSDATE - 67);
INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
VALUES (1, 'KYC documents verified successfully.', 'agent1', SYSDATE - 65);

INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
VALUES (2, 'Reset password instructions sent.', 'agent2', SYSDATE - 71);
INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
VALUES (2, 'Access restored successfully.', 'agent2', SYSDATE - 70);

INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
VALUES (3, 'Escalated to backend for loan unblock', 'agent3', SYSDATE - 60.5);

-- Month 2 updates (30-45 days ago)
INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
VALUES (4, 'Queued for card operations team', 'agent4', SYSDATE - 41.5);

INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
VALUES (5, 'Customer contacted via phone.', 'agent5', SYSDATE - 37);
INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
VALUES (5, 'FD reinstatement processed.', 'agent5', SYSDATE - 35);

INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
VALUES (6, 'Account closure confirmed.', 'agent6', SYSDATE - 44);
INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
VALUES (6, 'Final settlement completed.', 'agent6', SYSDATE - 40);

INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
VALUES (7, 'ATM dispute logged. Awaiting response', 'agent7', SYSDATE - 32.5);

-- Current month updates (0-20 days ago)
INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
VALUES (8, 'Ticket created and assigned', 'agent8', SYSDATE - 14.5);

INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
VALUES (9, 'Complaint acknowledged', 'agent9', SYSDATE - 7.5);

INSERT INTO cs_ticket_updates (ticket_id, update_text, updated_by, updated_at)
VALUES (10, 'Savings withdrawal issue recreated', 'agent10', SYSDATE - 2.5);

-- Interactions with dates spread across 3 months
-- Month 1 interactions (60-75 days ago)
-- Interactions for Ticket 1 (created SYSDATE - 68)
INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (1, 'Email', 'Welcome, please verify your KYC.', 'Outbound', SYSDATE - 68, 'agent1');

INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (1, 'Email', 'KYC documents attached as requested.', 'Inbound', SYSDATE - 67.5, 'alice@example.com');

INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (1, 'Email', 'Thank you. Your documents have been verified.', 'Outbound', SYSDATE - 65, 'agent1');

-- Interactions for Ticket 2 (created SYSDATE - 72)
INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (2, 'Chat', 'I am unable to access my corporate account.', 'Inbound', SYSDATE - 72, 'contact@betaltd.com');

INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (2, 'Chat', 'We are looking into your login issue.', 'Outbound', SYSDATE - 71.8, 'agent2');

INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (2, 'Chat', 'Your account access has been restored.', 'Outbound', SYSDATE - 70, 'agent2');

-- Interactions for Ticket 3 (created SYSDATE - 61)
INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (3, 'Call', 'Loan account is showing as blocked.', 'Inbound', SYSDATE - 61, 'charlie.b@example.com');

INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (3, 'Call', 'Your issue has been escalated for review.', 'Outbound', SYSDATE - 60.5, 'agent3');

-- Month 2 interactions (30-45 days ago)
-- Interactions for Ticket 4 (created SYSDATE - 42)
INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (4, 'Branch', 'I paid my credit card bill but it is not showing.', 'Inbound', SYSDATE - 42, 'help@delta.com');

INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (4, 'Branch', 'Our branch team will contact you for resolution.', 'Outbound', SYSDATE - 41.5, 'agent4');

-- Interactions for Ticket 5 (created SYSDATE - 38)
INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (5, 'SMS', 'Why was my Fixed Deposit closed?', 'Inbound', SYSDATE - 38, 'eve.m@gmail.com');

INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (5, 'SMS', 'We are investigating your Fixed Deposit issue.', 'Outbound', SYSDATE - 37.5, 'agent5');

INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (5, 'Email', 'Your FD has been reinstated. Apologies for the inconvenience.', 'Outbound', SYSDATE - 35, 'agent5');

-- Interactions for Ticket 6 (created SYSDATE - 45)
INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (6, 'Branch', 'My closed account is still showing as open.', 'Inbound', SYSDATE - 45, 'service@foxtrot.com');

INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (6, 'Email', 'We are processing your account closure confirmation.', 'Outbound', SYSDATE - 44, 'agent6');

-- Interactions for Ticket 7 (created SYSDATE - 33)
INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (7, 'Call', 'ATM did not dispense cash but my account was debited.', 'Inbound', SYSDATE - 33, 'grace.hopper@example.com');

INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (7, 'Call', 'Your ATM dispute has been logged. We will investigate.', 'Outbound', SYSDATE - 32.5, 'agent7');

-- Current month interactions (0-20 days ago)
-- Interactions for Ticket 8 (created SYSDATE - 15)
INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (8, 'Email', 'I cannot see my loan account details in the app.', 'Inbound', SYSDATE - 15, 'info@hotelinc.com');

INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (8, 'Email', 'We are looking into this display issue.', 'Outbound', SYSDATE - 14.5, 'agent8');

-- Interactions for Ticket 9 (created SYSDATE - 8)
INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (9, 'Email', 'Why was my credit card limit reduced without notice?', 'Inbound', SYSDATE - 8, 'ivy.lane@example.com');

INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (9, 'Email', 'We apologize for the lack of notification. Reviewing your case.', 'Outbound', SYSDATE - 7.5, 'agent9');

-- Interactions for Ticket 10 (created SYSDATE - 3)
INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (10, 'Chat', 'Unable to withdraw from my savings account despite sufficient balance.', 'Inbound', SYSDATE - 3, 'juliet@test.com');

INSERT INTO cs_interactions (ticket_id, channel, message_text, direction, created_at, created_by)
VALUES (10, 'Chat', 'We are investigating your withdrawal issue.', 'Outbound', SYSDATE - 2.5, 'agent10');

COMMIT;

-- ============================================================================
-- END OF DDL SCRIPT
-- ============================================================================